<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebBot - ç½‘ç«™ä¿®æ”¹æ™ºèƒ½åŠ©æ‰‹</title>
  <!-- Markdown æ¸²æŸ“ -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- ä»£ç é«˜äº® -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11"></script>
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a24;
      --bg-code: #161b22;
      --text-primary: #e8e8e8;
      --text-secondary: #a0a0a0;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --success: #22c55e;
      --error: #ef4444;
      --border: #2a2a36;
      --code-border: #30363d;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* App Layout */
    .app-layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
      transition: width 0.3s ease;
    }

    .sidebar.collapsed {
      width: 0;
      border-right: none;
    }

    .sidebar-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .sidebar-tab {
      flex: 1;
      padding: 10px 8px;
      text-align: center;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .sidebar-tab:hover {
      color: var(--text-primary);
      background: var(--bg-tertiary);
    }

    .sidebar-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .sidebar-panel {
      display: none;
    }

    .sidebar-panel.active {
      display: block;
    }

    .change-item,
    .snapshot-item {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 6px;
      background: var(--bg-tertiary);
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
      border: 1px solid transparent;
    }

    .change-item:hover,
    .snapshot-item:hover {
      background: var(--bg-primary);
      border-color: var(--border);
    }

    .change-item .time,
    .snapshot-item .time {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .change-item .action {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-right: 4px;
    }

    .action-write {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
    }

    .action-delete {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error);
    }

    .action-rename {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent);
    }

    .snapshot-item .rollback-btn {
      font-size: 11px;
      padding: 3px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      margin-top: 6px;
      transition: all 0.2s;
    }

    .snapshot-item .rollback-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .sidebar-empty {
      text-align: center;
      color: var(--text-secondary);
      font-size: 13px;
      padding: 24px 12px;
    }

    /* Main area */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      gap: 12px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-left .sidebar-toggle {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      font-size: 18px;
      display: flex;
    }

    .header-left .sidebar-toggle:hover {
      color: var(--text-primary);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .token-badge {
      font-size: 12px;
      color: var(--text-secondary);
      background: var(--bg-tertiary);
      padding: 4px 10px;
      border-radius: 6px;
      white-space: nowrap;
    }

    .token-badge span {
      color: var(--accent);
      font-weight: 600;
    }

    .preview-toggle {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }

    .preview-toggle:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .preview-toggle.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(99, 102, 241, 0.1);
    }

    /* Preview Panel */
    .preview-panel {
      width: 0;
      border-left: none;
      background: var(--bg-secondary);
      overflow: hidden;
      transition: width 0.3s ease;
      flex-shrink: 0;
    }

    .preview-panel.visible {
      width: 45%;
      border-left: 1px solid var(--border);
    }

    .preview-panel iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header h1::before {
      content: "ğŸ¤–";
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--error);
    }

    .status-dot.connected {
      background: var(--success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    /* Chat Container */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      max-width: 85%;
      padding: 16px 20px;
      border-radius: 16px;
      line-height: 1.7;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      background: var(--accent);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message.user img {
      max-width: 300px;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 8px;
      display: block;
    }

    .message.assistant {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .message.system {
      background: transparent;
      border: 1px dashed var(--border);
      color: var(--text-secondary);
      font-size: 13px;
      align-self: center;
      padding: 8px 16px;
    }

    .message.tool {
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.3);
      font-family: 'Fira Code', 'JetBrains Mono', monospace;
      font-size: 13px;
      align-self: flex-start;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
    }

    .message.tool::before {
      content: "ğŸ”§";
    }

    /* Markdown æ¸²æŸ“æ ·å¼ */
    .message.assistant h1,
    .message.assistant h2,
    .message.assistant h3,
    .message.assistant h4 {
      margin-top: 16px;
      margin-bottom: 10px;
      font-weight: 600;
      color: #fff;
    }

    .message.assistant h1 {
      font-size: 1.5em;
    }

    .message.assistant h2 {
      font-size: 1.3em;
      border-bottom: 1px solid var(--border);
      padding-bottom: 6px;
    }

    .message.assistant h3 {
      font-size: 1.15em;
    }

    .message.assistant h4 {
      font-size: 1em;
    }

    .message.assistant p {
      margin: 10px 0;
    }

    .message.assistant ul,
    .message.assistant ol {
      padding-left: 24px;
      margin: 10px 0;
    }

    .message.assistant li {
      margin: 6px 0;
    }

    .message.assistant li::marker {
      color: var(--accent);
    }

    .message.assistant strong {
      color: #fff;
      font-weight: 600;
    }

    .message.assistant em {
      color: var(--text-secondary);
    }

    .message.assistant code {
      font-family: 'Fira Code', 'JetBrains Mono', monospace;
      background: var(--bg-code);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.9em;
      border: 1px solid var(--code-border);
    }

    .message.assistant pre {
      background: var(--bg-code);
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 12px 0;
      border: 1px solid var(--code-border);
    }

    .message.assistant pre code {
      background: transparent;
      padding: 0;
      border: none;
      font-size: 13px;
      line-height: 1.5;
    }

    .message.assistant blockquote {
      border-left: 3px solid var(--accent);
      padding-left: 16px;
      margin: 12px 0;
      color: var(--text-secondary);
    }

    .message.assistant table {
      border-collapse: collapse;
      width: 100%;
      margin: 12px 0;
    }

    .message.assistant th,
    .message.assistant td {
      border: 1px solid var(--border);
      padding: 10px 14px;
      text-align: left;
    }

    .message.assistant th {
      background: var(--bg-code);
      font-weight: 600;
    }

    .message.assistant hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 16px 0;
    }

    .message.assistant a {
      color: var(--accent-hover);
      text-decoration: none;
    }

    .message.assistant a:hover {
      text-decoration: underline;
    }

    /* Input Area */
    .input-area {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding: 16px 24px;
      flex-shrink: 0;
    }

    /* å›¾ç‰‡é¢„è§ˆåŒº */
    .image-preview-area {
      display: none;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .image-preview-area.has-images {
      display: flex;
    }

    .image-preview-item {
      position: relative;
      display: inline-block;
    }

    .image-preview-item img {
      max-height: 80px;
      max-width: 120px;
      border-radius: 8px;
      border: 2px solid var(--border);
    }

    .image-preview-item .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      background: var(--error);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-preview-item .remove-btn:hover {
      background: #dc2626;
    }

    .input-wrapper {
      display: flex;
      gap: 12px;
      max-width: 1200px;
      margin: 0 auto;
      align-items: flex-end;
    }

    /* å›¾ç‰‡ä¸Šä¼ æŒ‰é’® */
    .upload-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .upload-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .upload-btn svg {
      width: 20px;
      height: 20px;
    }

    #imageInput {
      display: none;
    }

    .input-wrapper textarea {
      flex: 1;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 18px;
      color: var(--text-primary);
      font-size: 15px;
      resize: none;
      outline: none;
      transition: border-color 0.2s;
      font-family: inherit;
      min-height: 52px;
      max-height: 200px;
    }

    .input-wrapper textarea:focus {
      border-color: var(--accent);
    }

    .input-wrapper textarea::placeholder {
      color: var(--text-secondary);
    }

    .send-btn {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0 24px;
      min-height: 52px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .send-btn:hover {
      background: var(--accent-hover);
    }

    .send-btn:active {
      transform: scale(0.98);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-left">
      <button class="sidebar-toggle" id="sidebarToggle" title="åˆ‡æ¢ä¾§è¾¹æ ">â˜°</button>
      <h1 style="font-size:18px;font-weight:600">WebBot</h1>
      <div class="status">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">æœªè¿æ¥</span>
      </div>
    </div>
    <div class="header-right">
      <div class="token-badge" id="tokenBadge" title="Token æ¶ˆè€—ç»Ÿè®¡">
        ğŸ“Š <span id="tokenTotal">0</span> tokens
      </div>
      <button class="preview-toggle" id="previewToggle" title="ç½‘ç«™é¢„è§ˆ">
        ğŸŒ é¢„è§ˆ
      </button>
    </div>
  </header>

  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-panel="changelog">ğŸ“‹ å˜æ›´</button>
        <button class="sidebar-tab" data-panel="snapshots">ğŸ“¸ å¿«ç…§</button>
      </div>
      <div class="sidebar-content">
        <div class="sidebar-panel active" id="panelChangelog">
          <div class="sidebar-empty">æš‚æ— å˜æ›´è®°å½•</div>
        </div>
        <div class="sidebar-panel" id="panelSnapshots">
          <div class="sidebar-empty">æš‚æ— å¿«ç…§</div>
        </div>
      </div>
    </aside>

    <!-- Main Chat -->
    <div class="main-area">
      <main class="chat-container" id="chatContainer">
        <div class="message system">æ¬¢è¿ä½¿ç”¨ WebBotï¼è¿æ¥æœåŠ¡å™¨åå³å¯å¼€å§‹å¯¹è¯ã€‚æ”¯æŒå‘é€å›¾ç‰‡è¿›è¡Œå¤šæ¨¡æ€äº¤æµã€‚</div>
      </main>

      <footer class="input-area">
        <div class="image-preview-area" id="imagePreviewArea"></div>
        <div class="input-wrapper">
          <label class="upload-btn" for="imageInput" title="ä¸Šä¼ å›¾ç‰‡">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
              <circle cx="8.5" cy="8.5" r="1.5" />
              <polyline points="21 15 16 10 5 21" />
            </svg>
          </label>
          <input type="file" id="imageInput" accept="image/*" multiple />
          <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯... (æŒ‰ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ)" rows="1"></textarea>
          <button class="send-btn" id="sendBtn">
            <span>å‘é€</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
            </svg>
          </button>
        </div>
      </footer>
    </div>

    <!-- Preview Panel -->
    <div class="preview-panel" id="previewPanel">
      <iframe id="previewFrame" src="about:blank"></iframe>
    </div>
  </div><!-- end .app-layout -->

  <script>
    // åŠ¨æ€è·å– WebSocket URLï¼ˆä½¿ç”¨å½“å‰é¡µé¢ hostï¼Œç«¯å£ 8080ï¼‰
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsHost = window.location.hostname || '127.0.0.1';

    // è®¤è¯ Tokenï¼šä¼˜å…ˆä» URL å‚æ•°è·å–ï¼Œå…¶æ¬¡ä» localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const authToken = urlParams.get('token') || localStorage.getItem('webbot_token') || '';
    if (urlParams.get('token')) {
      localStorage.setItem('webbot_token', urlParams.get('token'));
      // æ¸…ç† URL å‚æ•°ï¼ˆéšè— tokenï¼‰
      window.history.replaceState({}, '', window.location.pathname);
    }

    const WS_URL = authToken
      ? `${wsProtocol}//${wsHost}:8080?token=${encodeURIComponent(authToken)}`
      : `${wsProtocol}//${wsHost}:8080`;

    let ws = null;
    let isConnected = false;
    let currentAssistantMessage = null;
    let currentContent = '';
    let messageId = 0;
    let pendingImages = [];
    let totalTokens = 0;
    let promptTokens = 0;
    let completionTokens = 0;

    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const imageInput = document.getElementById('imageInput');
    const imagePreviewArea = document.getElementById('imagePreviewArea');
    const tokenBadge = document.getElementById('tokenBadge');
    const tokenTotal = document.getElementById('tokenTotal');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const previewToggle = document.getElementById('previewToggle');
    const previewPanel = document.getElementById('previewPanel');
    const previewFrame = document.getElementById('previewFrame');
    const panelChangelog = document.getElementById('panelChangelog');
    const panelSnapshots = document.getElementById('panelSnapshots');

    // Detect preview URL
    const previewUrl = `http://${window.location.hostname}:8888`;

    // é…ç½® marked
    marked.setOptions({
      highlight: function (code, lang) {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
      },
      breaks: true,
      gfm: true
    });

    // å¤„ç†å›¾ç‰‡é€‰æ‹©
    imageInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      files.forEach(file => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const dataUrl = e.target.result;
            pendingImages.push({ type: 'base64', data: dataUrl });
            updateImagePreview();
          };
          reader.readAsDataURL(file);
        }
      });
      imageInput.value = ''; // é‡ç½®ä»¥ä¾¿å†æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶
    });

    // æ›´æ–°å›¾ç‰‡é¢„è§ˆ
    function updateImagePreview() {
      imagePreviewArea.innerHTML = '';
      pendingImages.forEach((img, index) => {
        const item = document.createElement('div');
        item.className = 'image-preview-item';
        item.innerHTML = `
          <img src="${img.data}" alt="é¢„è§ˆ">
          <button class="remove-btn" onclick="removeImage(${index})">Ã—</button>
        `;
        imagePreviewArea.appendChild(item);
      });
      imagePreviewArea.classList.toggle('has-images', pendingImages.length > 0);
    }

    // ç§»é™¤å›¾ç‰‡
    window.removeImage = function (index) {
      pendingImages.splice(index, 1);
      updateImagePreview();
    };

    // æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
    document.body.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
    });

    document.body.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const files = Array.from(e.dataTransfer.files);
      files.forEach(file => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            pendingImages.push({ type: 'base64', data: ev.target.result });
            updateImagePreview();
          };
          reader.readAsDataURL(file);
        }
      });
    });

    // Connect to WebSocket
    function connect() {
      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        isConnected = true;
        statusDot.classList.add('connected');
        statusText.textContent = 'å·²è¿æ¥';
        addSystemMessage('å·²è¿æ¥åˆ° WebBot æœåŠ¡å™¨');
      };

      ws.onclose = () => {
        isConnected = false;
        statusDot.classList.remove('connected');
        statusText.textContent = 'æœªè¿æ¥';
        addSystemMessage('è¿æ¥å·²æ–­å¼€ï¼Œ3ç§’åé‡è¿...');
        setTimeout(connect, 3000);
      };

      ws.onerror = (err) => {
        console.error('WebSocket error:', err);
      };

      ws.onmessage = (event) => {
        const frame = JSON.parse(event.data);
        handleFrame(frame);
      };
    }

    // Handle incoming frames
    function handleFrame(frame) {
      if (frame.event === 'connected') {
        console.log('Connected with ID:', frame.data.connectionId);
        refreshSidebar();
        return;
      }

      if (frame.event === 'chat') {
        handleChatEvent(frame.data);
        return;
      }

      if (frame.event === 'preview.reload') {
        if (previewPanel.classList.contains('visible')) {
          previewFrame.src = previewUrl + '?t=' + Date.now();
        }
        refreshSidebar();
        return;
      }

      if (frame.result !== undefined) {
        console.log('Response:', frame);
      }
    }

    // Handle chat events
    function handleChatEvent(event) {
      switch (event.type) {
        case 'text.delta':
          if (!currentAssistantMessage) {
            currentAssistantMessage = addMessage('', 'assistant');
            currentContent = '';
          }
          currentContent += event.text;
          currentAssistantMessage.innerHTML = marked.parse(currentContent);
          currentAssistantMessage.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
          });
          scrollToBottom();
          break;

        case 'tool.call':
          addMessage(`è°ƒç”¨å·¥å…·: ${event.toolName}`, 'tool');
          break;

        case 'tool.result':
          break;

        case 'usage':
          if (event.usage) {
            promptTokens += event.usage.promptTokens || 0;
            completionTokens += event.usage.completionTokens || 0;
            totalTokens = promptTokens + completionTokens;
            tokenTotal.textContent = totalTokens.toLocaleString();
            tokenBadge.title = `Prompt: ${promptTokens.toLocaleString()} / Completion: ${completionTokens.toLocaleString()}`;
          }
          break;

        case 'done':
          currentAssistantMessage = null;
          currentContent = '';
          sendBtn.disabled = false;
          refreshSidebar();
          break;

        case 'error':
          addMessage(`âŒ é”™è¯¯: ${event.error}`, 'system');
          currentAssistantMessage = null;
          currentContent = '';
          sendBtn.disabled = false;
          break;
      }
    }

    // Add message to chat
    function addMessage(text, type, images = []) {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;

      if (type === 'assistant') {
        msg.innerHTML = marked.parse(text);
      } else if (type === 'user') {
        msg.textContent = text;
        // æ˜¾ç¤ºå‘é€çš„å›¾ç‰‡
        images.forEach(img => {
          const imgEl = document.createElement('img');
          imgEl.src = img.data;
          imgEl.alt = 'å·²å‘é€å›¾ç‰‡';
          msg.appendChild(imgEl);
        });
      } else {
        msg.textContent = text;
      }

      chatContainer.appendChild(msg);
      scrollToBottom();
      return msg;
    }

    // Add system message
    function addSystemMessage(text) {
      addMessage(text, 'system');
    }

    // Scroll to bottom
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Send message
    function sendMessage() {
      const content = messageInput.value.trim();
      if ((!content && pendingImages.length === 0) || !isConnected) return;

      // Add user message with images
      addMessage(content || '(å›¾ç‰‡)', 'user', pendingImages);
      messageInput.value = '';
      messageInput.style.height = 'auto';

      // Send to server
      const params = { content: content || 'è¯·æè¿°è¿™å¼ å›¾ç‰‡' };
      if (pendingImages.length > 0) {
        params.images = pendingImages;
      }

      ws.send(JSON.stringify({
        id: `msg-${++messageId}`,
        method: 'chat.send',
        params
      }));

      // æ¸…ç©ºå¾…å‘é€å›¾ç‰‡
      pendingImages = [];
      updateImagePreview();

      sendBtn.disabled = true;
    }

    // Event listeners
    sendBtn.addEventListener('click', sendMessage);

    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Auto-resize textarea
    messageInput.addEventListener('input', () => {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
    });

    // ç²˜è´´å›¾ç‰‡æ”¯æŒ
    messageInput.addEventListener('paste', (e) => {
      const items = Array.from(e.clipboardData.items);
      items.forEach(item => {
        if (item.type.startsWith('image/')) {
          e.preventDefault();
          const file = item.getAsFile();
          const reader = new FileReader();
          reader.onload = (ev) => {
            pendingImages.push({ type: 'base64', data: ev.target.result });
            updateImagePreview();
          };
          reader.readAsDataURL(file);
        }
      });
    });

    // ==================== Sidebar ====================

    // Tab switching
    document.querySelectorAll('.sidebar-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel' + tab.dataset.panel.charAt(0).toUpperCase() + tab.dataset.panel.slice(1)).classList.add('active');
      });
    });

    // Toggle sidebar
    sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));

    // Toggle preview
    previewToggle.addEventListener('click', () => {
      const visible = previewPanel.classList.toggle('visible');
      previewToggle.classList.toggle('active', visible);
      if (visible) previewFrame.src = previewUrl;
    });

    // Refresh sidebar data
    function refreshSidebar() {
      if (!ws || ws.readyState !== 1) return;

      // Fetch changelog
      ws.send(JSON.stringify({ id: 'cl-' + Date.now(), method: 'changelog.list', params: { limit: 30 } }));
      // Fetch snapshots
      ws.send(JSON.stringify({ id: 'sl-' + Date.now(), method: 'snapshot.list', params: {} }));

      // One-time listener for responses
      const handler = (ev) => {
        const frame = JSON.parse(ev.data);
        if (frame.id && frame.id.startsWith('cl-') && frame.result) {
          renderChangelog(frame.result.entries || []);
        }
        if (frame.id && frame.id.startsWith('sl-') && frame.result) {
          renderSnapshots(frame.result.snapshots || []);
        }
      };
      ws.addEventListener('message', handler);
      setTimeout(() => ws.removeEventListener('message', handler), 3000);
    }

    // Render changelog
    function renderChangelog(entries) {
      if (!entries.length) {
        panelChangelog.innerHTML = '<div class="sidebar-empty">æš‚æ— å˜æ›´è®°å½•</div>';
        return;
      }
      panelChangelog.innerHTML = entries.map(e => `
        <div class="change-item">
          <div class="time">${new Date(e.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</div>
          <span class="action action-${e.action}">${e.action}</span>
          <span style="font-size:13px">${e.summary}</span>
        </div>
      `).join('');
    }

    // Render snapshots
    function renderSnapshots(snapshots) {
      if (!snapshots.length) {
        panelSnapshots.innerHTML = '<div class="sidebar-empty">æš‚æ— å¿«ç…§</div>';
        return;
      }
      panelSnapshots.innerHTML = snapshots.slice(0, 30).map(s => `
        <div class="snapshot-item">
          <div class="time">${new Date(s.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</div>
          <div style="font-size:13px">${s.filePath}</div>
          <div style="font-size:11px;color:var(--text-secondary)">${s.action} Â· ${(s.fileSize / 1024).toFixed(1)}KB</div>
          <button class="rollback-btn" onclick="doRollback('${s.id}')">â†© å›æ»š</button>
        </div>
      `).join('');
    }

    // Rollback handler
    window.doRollback = function(snapshotId) {
      if (!confirm('ç¡®å®šè¦å›æ»šè¯¥æ–‡ä»¶åˆ°å¿«ç…§ç‰ˆæœ¬å—ï¼Ÿ')) return;
      ws.send(JSON.stringify({ id: 'rb-' + Date.now(), method: 'snapshot.rollback', params: { snapshotId } }));
      setTimeout(refreshSidebar, 500);
    };

    // Start connection
    connect();
  </script>
</body>

</html>